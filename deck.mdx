import { Appear, Head } from 'mdx-deck';
import { CodeSurferLayout } from "code-surfer";
import "prismjs/components/prism-java";
import "prismjs/components/prism-scala";

import { Graphviz } from "./Graphviz";
import { Railroad, Red } from "./Railroad";
import rr from "railroad-diagrams";

import { github } from "code-surfer";

import { dark, prism } from 'mdx-deck/themes';
import myTheme from './myTheme';

export const themes = [prism, myTheme];

import "./custom.css";

# Scala 3, type inference and you!

Guillaume Martres - EPFL

---

# Scala compiler pipeline

<Graphviz dot={[
`
digraph {
bgcolor=transparent;
rankdir=LR;
node [fontsize="38.0", fontname="Source Sans Pro, Noto Color Emoji", shape="box"];
magic [label="✨ Magic ✨", style="filled", fillcolor="#d6c8ff"];
src [label="Hello.scala", shape="note", style="filled", fillcolor="#f8f3d4"];
dst [label="Hello.class", shape="note", style="filled", fillcolor="#f8f3d4"];
{ rank=same src magic dst }
src -> magic -> dst;
}
`,
`
digraph {
bgcolor=transparent;
rankdir=LR;
node [fontsize="38.0", fontname="Source Sans Pro, Noto Color Emoji", shape="box"];
magic [label="✨ Magic ✨", style="filled", fillcolor="#d6c8ff"];
src [label="Hello.scala", shape="note", style="filled", fillcolor="#f8f3d4"];
dst [label="Hello.class", shape="note", style="filled", fillcolor="#f8f3d4"];
Parser [ style="bold", color="#ef4b4b"];
{ rank=same src Parser }
{ rank=same magic dst }
src -> Parser -> magic -> dst;
}
`,
]} />

---

# Parsing

<Graphviz dot={[
`
digraph {
margin=1.0;
bgcolor=transparent;
labelloc="t";
fontname="Fira Mono";
fontsize="50.0";
label=< <b>foo</b>  <b>.elem(5)</b>  >;
}
`,
`
digraph {
margin=1.0;
bgcolor=transparent;
rankdir=TB;
node [shape="box", fontname="Source Sans Pro, Noto Color Emoji", fontsize="38.0", style="rounded, filled", fillcolor="#cde498"];
foo [label="\\\"foo\\\"", style="filled", fontcolor="#b36232"]
Ident -> foo
labelloc="t";
fontname="Fira Mono";
fontsize="50.0";
label=< <b>foo</b>  >;
}
`,
`
digraph {
margin=0.5;
bgcolor=transparent;
rankdir=TB;
node [shape="box", fontname="Source Sans Pro, Noto Color Emoji", fontsize="38.0", style="rounded, filled"];
foo [label="\\\"foo\\\"", style="filled", fontcolor="#b36232"]
Ident -> foo
node [fillcolor="#cde498"];
elem [label="\\\"elem\\\"", style="filled", fontcolor="#b36232"]
Select -> Ident
Select -> elem
labelloc="t";
fontname="Fira Mono";
fontsize="50.0";
label=<             <b>foo.elem</b>                    >;
}
`,
`
digraph {
bgcolor=transparent;
rankdir=TB;
node [shape="box", fontname="Source Sans Pro, Noto Color Emoji", fontsize="38.0", style="rounded, filled"];
foo [label="\\\"foo\\\"", style="filled", fontcolor="#b36232"]
Ident -> foo
elem [label="\\\"elem\\\"", style="filled", fontcolor="#b36232"]
Select -> Ident
Select -> elem
node [fillcolor="#cde498"];
5 [style="filled", fontcolor="#b36232"]
  Apply -> Select
Apply -> Literal -> 5
labelloc="t";
fontname="Fira Mono";
fontsize="50.0";
label=<             <b>foo.elem(5)</b>                    >;
}
`,
]} />

---

<Graphviz dot={[
`
digraph {
bgcolor=transparent;
rankdir=LR;
node [fontsize="38.0", fontname="Source Sans Pro, Noto Color Emoji", shape="box"];
magic [label="✨ Magic ✨", style="filled", fillcolor="#d6c8ff"];
src [label="Hello.scala", shape="note", style="filled", fillcolor="#f8f3d4"];
dst [label="Hello.class", shape="note", style="filled", fillcolor="#f8f3d4"];
{ rank=same src Parser }
{ rank=same magic dst }
src -> Parser -> magic -> dst;
}
`,
`
digraph {
bgcolor=transparent;
rankdir=LR;
node [fontsize="38.0", fontname="Source Sans Pro, Noto Color Emoji", shape="box"];
magic [label="✨ Magic ✨", style="filled", fillcolor="#d6c8ff"];
src [label="Hello.scala", shape="note", style="filled", fillcolor="#f8f3d4"];
dst [label="Hello.class", shape="note", style="filled", fillcolor="#f8f3d4"];
Typer [ style="bold", color="#ef4b4b"];
{ rank=same src Parser }
{ rank=same magic dst }
src -> Parser -> Typer -> magic -> dst;
}
`,
]} />

---

# Typing

```scala
class A {
  def elem(x: Int): Int
  def elem(x: String): String
}
val foo: A
// Expression to type
foo.elem(5)
```

---

# Typing

<Graphviz dot={[
`
digraph {
bgcolor=transparent;
rankdir=TB;
node [shape="box", fontname="Source Sans Pro, Noto Color Emoji", fontsize="38.0", style="rounded, filled"];
foo [label="\\\"foo\\\"", style="filled", fontcolor="#b36232"]
Ident -> foo
elem [label="\\\"elem\\\"", style="filled", fontcolor="#b36232"]
Select -> Ident
Select -> elem
5 [style="filled", fontcolor="#b36232"]
Apply -> Select
Apply -> Literal
Literal -> 5
}
`,
`
digraph {
bgcolor=transparent;
rankdir=TB;
node [shape="box", fontname="Source Sans Pro, Noto Color Emoji", fontsize="38.0", style="rounded, filled"];
foo [label="\\\"foo\\\"", style="filled", fontcolor="#b36232"]
Ident -> foo
elem [label="\\\"elem\\\"", style="filled", fontcolor="#b36232"]
Select -> Ident
Select -> elem
5 [style="filled", fontcolor="#b36232"]
Apply -> Select [color="#ef4b4b", fontcolor="#ef4b4b", label="?(...)"];
Apply -> Literal
Literal -> 5
}
`,
`
digraph {
bgcolor=transparent;
rankdir=TB;
node [shape="box", fontname="Source Sans Pro, Noto Color Emoji", fontsize="38.0", style="rounded, filled"];
foo [label="\\\"foo\\\"", style="filled", fontcolor="#b36232"]
Ident -> foo
elem [label="\\\"elem\\\"", style="filled", fontcolor="#b36232"]
Select -> Ident [color="#ef4b4b"];
Select -> elem
5 [style="filled", fontcolor="#b36232"]
Apply -> Select [color="#ef4b4b", fontcolor="#ef4b4b", label="?(...)"];
Apply -> Literal
Literal -> 5
}
`,
`
digraph {
bgcolor=transparent;
rankdir=TB;
node [shape="box", fontname="Source Sans Pro, Noto Color Emoji", fontsize="38.0", style="rounded, filled"];
foo [label="\\\"foo\\\"", style="filled", fontcolor="#b36232"]
    Ident [shape="record", label="Ident | foo.type", fillcolor="#fae3d9"]
Ident -> foo
elem [label="\\\"elem\\\"", style="filled", fontcolor="#b36232"]
Select -> Ident [color="#ef4b4b", fontcolor="#ef4b4b", label="?.elem"];
Select -> elem
5 [style="filled", fontcolor="#b36232"]
Apply -> Select [color="#ef4b4b", fontcolor="#ef4b4b", label="?(...)"];
Apply -> Literal
Literal -> 5
}
`,
`
digraph {
bgcolor=transparent;
rankdir=TB;
node [shape="box", fontname="Source Sans Pro, Noto Color Emoji", fontsize="38.0", style="rounded, filled"];
foo [label="\\\"foo\\\"", style="filled", fontcolor="#b36232"]
Ident [shape="record", label="Ident | foo.type", fillcolor="#fae3d9"]
Select [shape="record", label="Select | foo.elem.type", fillcolor="#fae3d9"]
Ident -> foo
elem [label="\\\"elem\\\"", style="filled", fontcolor="#b36232"]
Select -> Ident;
Select -> elem
5 [style="filled", fontcolor="#b36232"]
Apply -> Select [color="#ef4b4b", fontcolor="#ef4b4b", label="?(...)"];
Apply -> Literal
Literal -> 5
}
`,
`
digraph {
bgcolor=transparent;
rankdir=TB;
node [shape="box", fontname="Source Sans Pro, Noto Color Emoji", fontsize="38.0", style="rounded, filled"];
foo [label="\\\"foo\\\"", style="filled", fontcolor="#b36232"]
Ident [shape="record", label="Ident | foo.type", fillcolor="#fae3d9"]
Select [shape="record", label="Select | foo.elem.type", fillcolor="#fae3d9"]
Literal [shape="record", label="Literal | 5", fillcolor="#fae3d9"]
Ident -> foo
elem [label="\\\"elem\\\"", style="filled", fontcolor="#b36232"]
Select -> Ident;
Select -> elem
5 [style="filled", fontcolor="#b36232"]
Apply -> Select [color="#ef4b4b", fontcolor="#ef4b4b", label="?(Int)"];
Apply -> Literal;
Literal -> 5
}
`,
`
digraph {
bgcolor=transparent;
rankdir=TB;
node [shape="box", fontname="Source Sans Pro, Noto Color Emoji", fontsize="38.0", style="rounded, filled"];
foo [label="\\\"foo\\\"", style="filled", fontcolor="#b36232"]
Ident [shape="record", label="Ident | foo.type", fillcolor="#fae3d9"]
Select [shape="record", label="Select | foo.elem.type", fillcolor="#fae3d9"]
Literal [shape="record", label="Literal | 5", fillcolor="#fae3d9"]
Ident -> foo
elem [label="\\\"elem\\\"", style="filled", fontcolor="#b36232"]
Select -> Ident;
Select -> elem
5 [style="filled", fontcolor="#b36232"]
Apply -> Select [color="#ef4b4b", fontcolor="#ef4b4b", label="?(Int)"];
Apply -> Literal;
Literal -> 5
}
`,
`
digraph {
bgcolor=transparent;
rankdir=TB;
node [shape="box", fontname="Source Sans Pro, Noto Color Emoji", fontsize="38.0", style="rounded, filled"];
foo [label="\\\"foo\\\"", style="filled", fontcolor="#b36232"]
Ident [shape="record", label="Ident | foo.type", fillcolor="#fae3d9"]
Select [shape="record", label="Select | foo.elem.type \\(Int \\=\\> Int\\)", fillcolor="#fae3d9"]
Literal [shape="record", label="Literal | 5", fillcolor="#fae3d9"]
Ident -> foo
elem [label="\\\"elem\\\"", style="filled", fontcolor="#b36232"]
Select -> Ident;
Select -> elem
5 [style="filled", fontcolor="#b36232"]
Apply -> Select;
Apply -> Literal;
Literal -> 5
}
`,
`
digraph {
bgcolor=transparent;
rankdir=TB;
node [shape="box", fontname="Source Sans Pro, Noto Color Emoji", fontsize="38.0", style="rounded, filled"];
foo [label="\\\"foo\\\"", style="filled", fontcolor="#b36232"]
Ident [shape="record", label="Ident | foo.type", fillcolor="#fae3d9"]
Select [shape="record", label="Select | foo.elem.type", fillcolor="#fae3d9"]
Literal [shape="record", label="Literal | 5", fillcolor="#fae3d9"]
Apply [shape="record", label="Apply | Int", fillcolor="#fae3d9"]
Ident -> foo
elem [label="\\\"elem\\\"", style="filled", fontcolor="#b36232"]
Select -> Ident;
Select -> elem
5 [style="filled", fontcolor="#b36232"]
Apply -> Select
Apply -> Literal
Literal -> 5
}
`,
]} />

---

# What if there's a type mismatch ?

<ul>
  The <b>computed type</b> of a tree might not match its <b
  style="color: #ef4b4b;">expected type</b>.<br/>
  <Appear>
    <span>When this happens, the typechecker will attempt to <b style="color: #91b029;">adapt</b> the tree.</span>
    <li><span style="font-family: Fira Mono;">List<span style="color: #ef4b4b;">(1, 2)</span></span></li>
    <li><span style="font-family: Fira Mono;">↳List<span style="color: #91b029;">.apply</span><span style="color: #ef4b4b;">(1, 2)</span></span></li>
    <li><span style="font-family: Fira Mono;"> xs.max <span style="color: #ef4b4b;">: Int</span></span></li>
    <li><span style="font-family: Fira Mono;">↳xs.max<span style="color: #91b029;">(scala.math.Ordering.Int)</span> <span style="color: #ef4b4b;">: Int</span></span></li>
  </Appear>
</ul>

---

# Type parameter inference

```scala
def id[T](x: T): T = x
id(1) // How is this typed?
```
<ol>
<Appear>
<li><span style="color: #91b029;">Adapt</span> the expression by creating a <b style="color: #00a2b3;">type variable</b> for each missing type argument:</li>
<span><span style="font-family: Fira Mono;">id<span style="color: #91b029;">[</span><span style="color: #00a2b3;">T?</span><span style="color: #91b029;">]</span>(1)</span></span>
<li>Record the <b style="color: #ff80ae;">subtyping constraints</b> required for typechecking:</li>
<span><span style="font-family: Fira Mono;"><span style="color:
#00a2b3;">T?</span> <span style="color: #ff80ae;">&gt;: 1 &lt;: Any</span></span></span>
<li>Finally, <b style="color: #930077;">instantiate</b> the <span style="color: #00a2b3;">type variable</span> to a type that satisfies its <span style="color: #ff80ae;">constraints</span>:<br/>
    <span style="font-family: Fira Mono;"><span style="font-family: Fira Mono;">id<span style="color: #91b029;">[</span><span style="color: #930077;">Int</span><span style="color: #91b029;">]</span>(1)</span></span>
</li>
</Appear>
</ol>

---

# The art of <span style="color: #930077;">instantiation</span>

<ul>
<li><b>When</b> should a <span style="color:#00a2b3;">type variable</span> be <span style="color: #930077;">instantiated</span>?</li>
<ul>
<Appear>
<li>If <b>too early</b>: miss <span style="color: #ff80ae;">constraints</span></li>
<li>If <b>too late</b>: typechecking gets stuck</li>
<li>Solution: be lazy, do it only <b>when necessary</b></li>
</Appear>
</ul>
<li><b>What</b> should <span style="font-family: Fira Mono;"><span
style="color:#00a2b3;">T?</span> <span style="color: #ff80ae;">&gt;: Lo &lt;:
Hi</span></span> be <span style="color: #930077;">instantiated</span> to?</li>
<ul>
<Appear>
<span></span>
<span></span>
<span></span>
<li>If <span style="font-family: Fira Mono;"><span style="color:
#ff80ae;">Lo</span> =:= <span style="color: #ff80ae;">Hi</span></span>, just
pick one arbitrarily</li>
<li>Otherwise, look at the <b>position</b> of <span style="font-family: Fira Mono; color:#00a2b3;">T?</span></li>
</Appear>
</ul>
</ul>

---

# Thank you!

